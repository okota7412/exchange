{% extends 'labo_app/base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block title %}ajaxページ{% endblock %}
{% block css_js %}
    <link href="{% static 'labo_app/css/loading.css' %}" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}
{% block content %}
<form id="commandForm">
    {% csrf_token %}
    <input type="text" name="command" placeholder="コマンドを入力">
    <button type="submit">実行</button>
</form>

<div id="results"></div>

<script>
//document.getElementById('commandForm').addEventListener('submit', function(event) {
$('#commandForm').submit(function(event) {
    event.preventDefault();
    var command = document.querySelector('input[name="command"]').value;
    //var formData = {'command': $('#command').val() };
    var csrftoken = '{{ csrf_token }}';
    console.log(JSON.stringify({ commands: command}))
    
    function fetchResults() {
        $.ajax({
            url: '{% url "ajax" %}',  // DjangoビューのURLを指定
            type: 'POST',
            data: JSON.stringify({ commands: command}),
            //data: {commands: [command]},  // コマンドを配列で送信
            dataType: 'json',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function(data) {
                // 結果を表示
                var resultsDiv = document.getElementById('results');
                //resultsDiv.innerHTML = '';  // 以前の結果をクリア

                data.results.forEach(function(result) {
                    var resultDiv = document.createElement('div');
                    resultDiv.innerHTML = '<strong>コマンド:</strong> ' + result.command + '<br>' +
                                         '<strong>出力:</strong> ' + result.output + '<br>' +
                                         '<strong>エラー:</strong> ' + result.error + '<hr>';
                    resultsDiv.appendChild(resultDiv);
                });

                // すべてのコマンドが実行されたらページを遷移
                if (data.results.length == 1 && data.results[0].output.includes('すべてのコマンドが実行されました')) {
                    clearInterval(interval);  // ポーリングを停止
                    window.location.href = '/labo_app/simu/';
                }
            }
        });
    }

    // 5秒ごとに結果を取得
    // var interval = setInterval(fetchResults, 5000);

    // 最初の一回は即座に実行
    fetchResults();

    // CSRFトークンを取得する関数
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // クッキー名が一致する場合、値を取得
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
